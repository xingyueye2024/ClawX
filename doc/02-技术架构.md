# ClawX 技术架构

## 技术栈总览

### 运行时与框架

| 技术 | 版本 | 用途 |
|------|------|------|
| Electron | 40+ | 跨平台桌面应用框架 |
| React | 19 | UI 组件库 |
| TypeScript | - | 类型安全开发 |
| Node.js | 22+ | JavaScript 运行时 |

### 前端技术

| 技术 | 用途 |
|------|------|
| Vite | 构建工具与开发服务器 |
| React Router 7 | 客户端路由 |
| Zustand | 轻量级状态管理 |
| Tailwind CSS | 原子化 CSS 框架 |
| shadcn/ui | 精美 UI 组件库 |
| Framer Motion | 动画库 |
| Lucide React | 图标库 |
| React Markdown | Markdown 渲染（支持 remark-gfm） |
| i18next | 国际化方案 |
| Sonner | Toast 通知组件 |

### 后端技术（Electron 主进程）

| 技术 | 用途 |
|------|------|
| electron-store | 持久化设置存储 |
| electron-updater | 自动更新功能 |
| WebSocket (ws) | 与 Gateway 通信 |
| OpenClaw (2026.2.6-3) | 内嵌 AI 代理运行时 |
| ClawHub (0.5.0) | 技能市场客户端 |
| uv | Python 环境管理器（内嵌） |

### 开发工具

| 工具 | 用途 |
|------|------|
| ESLint | 代码检查 |
| Prettier | 代码格式化 |
| Vitest | 单元测试 |
| Playwright | E2E 端到端测试 |
| electron-builder | 打包与分发 |
| zx | 脚本工具 |

## 架构设计

### 整体架构

```
┌──────────────────────────────────────────────────────┐
│                    ClawX 桌面应用                       │
│  ┌─────────────────────┐  ┌────────────────────────┐  │
│  │   Electron 主进程    │  │   React 渲染进程        │  │
│  │                     │  │                        │  │
│  │  ┌───────────────┐  │  │  ┌──────────────────┐  │  │
│  │  │ Gateway 管理器 │◄─┼──┼─►│ Zustand Store    │  │  │
│  │  └───────┬───────┘  │  │  └──────────────────┘  │  │
│  │          │          │  │                        │  │
│  │  ┌───────▼───────┐  │  │  ┌──────────────────┐  │  │
│  │  │ OpenClaw 进程  │  │  │  │ React 组件        │  │  │
│  │  │ (Python)      │  │  │  │ (页面/UI)         │  │  │
│  │  └───────────────┘  │  │  └──────────────────┘  │  │
│  │                     │  │                        │  │
│  │  ┌───────────────┐  │  │  ┌──────────────────┐  │  │
│  │  │ 安全存储       │  │  │  │ React Router     │  │  │
│  │  │ (Keychain)    │  │  │  │ (Hash 路由)       │  │  │
│  │  └───────────────┘  │  │  └──────────────────┘  │  │
│  └─────────────────────┘  └────────────────────────┘  │
│              ▲ IPC (preload) ▲                        │
│              └────────────────┘                        │
└──────────────────────────────────────────────────────┘
```

### 进程间通信（IPC）

ClawX 采用 Electron 标准的进程隔离架构：

- **主进程（Main Process）**：管理窗口、Gateway 进程生命周期、安全存储、系统 API 调用
- **渲染进程（Renderer Process）**：运行 React 应用，负责 UI 渲染与用户交互
- **Preload 脚本**：作为安全桥梁，在沙箱环境中暴露受限的 API 给渲染进程

关键安全措施：
- `contextIsolation: true` — 上下文隔离已启用
- `nodeIntegration: false` — 渲染进程不可直接访问 Node.js
- 通过 Preload 脚本安全暴露 IPC 通道

### Gateway 管理器

Gateway 管理器是主进程的核心模块，负责管理 OpenClaw 运行时：

```
Gateway 管理器
├── 进程生命周期管理
│   ├── 自动启动 Gateway 进程
│   ├── 进程监控与健康检查（每 30 秒）
│   ├── 优雅关闭
│   └── 自动重连（指数退避，最多 10 次）
├── 通信层
│   ├── WebSocket 连接管理
│   ├── OpenClaw Protocol v3 握手
│   ├── JSON-RPC 2.0 调用
│   └── Ping/Keep-alive 心跳
├── 环境配置
│   ├── 内嵌 uv（Python 包管理器）
│   ├── API Key 环境变量注入
│   ├── Token 认证
│   └── 平台特定二进制文件解析
└── 事件转发
    ├── 聊天消息流（chat.delta / chat.final）
    ├── 频道状态更新（channel.status）
    ├── 协议事件（tick / notification）
    └── 错误传播
```

### 状态管理

应用使用 Zustand 进行状态管理，按领域划分为多个独立 Store：

| Store | 职责 |
|-------|------|
| `settings` | 应用设置（主题、语言、启动行为、Gateway 配置、更新偏好） |
| `gateway` | Gateway 连接状态、健康监控、RPC 通信、事件处理 |
| `chat` | 聊天消息、会话管理、流式状态、工具调用追踪、文件附件 |
| `channels` | 频道列表与状态、连接/断开操作、QR 码处理 |
| `skills` | 已安装技能、ClawHub 搜索与安装、启用/禁用管理 |
| `cron` | 定时任务 CRUD、启用/禁用、手动触发 |
| `providers` | AI 提供商配置、API Key 管理、默认提供商选择 |
| `update` | 自动更新检查、下载、版本信息 |

### 路由架构

使用 React Router 的 HashRouter（兼容 Electron 文件协议）：

```
路由结构
├── /setup/*          → 初始化向导（首次启动）
├── /                 → 聊天界面（主页）
├── /dashboard        → 系统仪表盘
├── /channels         → 频道管理
├── /skills           → 技能市场
├── /cron             → 定时任务
└── /settings/*       → 设置面板
```

- `MainLayout` 包裹所有主路由（侧边栏 + 标题栏 + 内容区）
- `Setup` 使用独立布局

### 组件架构

```
组件层级
├── 布局组件
│   ├── MainLayout        — 主应用容器（侧边栏 + 内容区）
│   ├── Sidebar           — 导航侧边栏（可折叠）
│   └── TitleBar          — 自定义窗口控制栏
├── UI 基础组件（shadcn/ui）
│   ├── Button / Card / Input / Select / Switch
│   ├── Tabs / Dialog / Dropdown / Tooltip
│   ├── Progress / Badge / Separator / Label
│   └── Textarea
├── 业务组件
│   ├── ChatMessage       — 聊天消息渲染（含工具状态）
│   ├── ChatInput         — 消息输入（含文件附件）
│   ├── ChatToolbar       — 会话管理与控制
│   ├── ProvidersSettings — AI 提供商管理
│   ├── UpdateSettings    — 更新配置
│   └── StatusBadge       — 连接/状态指示器
└── 通用组件
    ├── LoadingSpinner    — 加载状态
    └── ErrorBoundary     — 错误边界
```
